import{s as i}from"./index-zzFyhS3F.js";const O=async()=>{if(!i)throw new Error("Supabase no está configurado");try{const{data:t,error:n}=await i.from("squads").select("id, squad_key, squad_name").order("squad_name",{ascending:!0});if(n)throw n;return t||[]}catch(t){throw console.error("[DEVELOPER_METRICS] Error obteniendo squads:",t),t}},v=async t=>{if(!i)throw new Error("Supabase no está configurado");try{const{data:n,error:o}=await i.from("sprints").select("id, sprint_key, sprint_name, start_date, end_date, squad_id").eq("squad_id",t).order("start_date",{ascending:!1});if(o)throw o;const l=new Date;return(n||[]).map(s=>{const E=s.end_date?new Date(s.end_date):null,a=E?E>=l:!1;return{...s,is_active:a}})}catch(n){throw console.error("[DEVELOPER_METRICS] Error obteniendo sprints:",n),n}},L=async t=>{if(!i)throw new Error("Supabase no está configurado");try{const{data:n,error:o}=await i.from("issues").select("assignee_id").not("assignee_id","is",null);if(o)throw o;const l=[...new Set(n.map(c=>c.assignee_id).filter(Boolean))];if(l.length===0)return[];const{data:p,error:s}=await i.from("developers").select("id, display_name, email").in("id",l).eq("active",!0).order("display_name",{ascending:!0});if(s)throw s;const{data:E,error:a}=await i.from("initiatives").select("id").eq("squad_id",t);if(a)throw a;const _=(E||[]).map(c=>c.id),{data:h,error:d}=await i.from("issues").select("assignee_id").in("initiative_id",_).not("assignee_id","is",null);if(d)throw d;const u=[...new Set(h.map(c=>c.assignee_id).filter(Boolean))];return(p||[]).filter(c=>u.includes(c.id))}catch(n){throw console.error("[DEVELOPER_METRICS] Error obteniendo developers:",n),n}},T=async(t,n=null,o=null)=>{var p;if(!i)throw new Error("Supabase no está configurado");if(!t)throw new Error("Developer ID es requerido");if(typeof t!="string"||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))throw console.error("[DEVELOPER_METRICS] ID inválido:",t,typeof t),new Error(`ID de desarrollador inválido: ${t}. Debe ser un UUID válido.`);try{let s=null;if(o){const{data:e,error:r}=await i.from("sprints").select("sprint_name").eq("id",o).single();if(r)throw r;if(s=(p=e==null?void 0:e.sprint_name)==null?void 0:p.trim(),console.log("[DEVELOPER_METRICS] Sprint seleccionado:",{sprintId:o,sprintName:s,sprintNameLength:s==null?void 0:s.length}),!s)return{tickets:[],metrics:{totalTickets:0,withSP:0,noSP:0,totalSP:0,devDone:0,devDoneSP:0,totalSPAssigned:0,devDoneRate:0,spDevDoneRate:0},statusBreakdown:{}}}let E=i.from("issues").select(`
        id,
        issue_key,
        summary,
        current_status,
        current_story_points,
        current_sprint,
        assignee_id,
        initiative_id,
        initiatives(
          id,
          squad_id,
          squads(
            id,
            squad_key,
            squad_name
          )
        )
      `).eq("assignee_id",t);if(s){const e=s.trim();console.log("[DEVELOPER_METRICS] Filtrando por current_sprint:",{sprintName:e,sprintNameQuoted:`"${e}"`,sprintNameLength:e.length,originalSprintName:s,originalLength:s.length}),E=E.eq("current_sprint",e)}else console.log("[DEVELOPER_METRICS] ⚠️ No hay sprint seleccionado, obteniendo TODOS los issues del developer (sin filtrar por sprint)");const{data:a,error:_}=await E;if(_)throw console.error("[DEVELOPER_METRICS] Error en query:",_),_;const h=[...new Set((a||[]).map(e=>e.current_sprint).filter(Boolean))];console.log("[DEVELOPER_METRICS] Issues obtenidos antes de filtrar por squad:",{total:(a==null?void 0:a.length)||0,sprintNameFilter:s,uniqueCurrentSprints:h,sampleIssues:(a||[]).slice(0,3).map(e=>({key:e.issue_key,current_sprint:e.current_sprint,current_sprintQuoted:`"${e.current_sprint}"`,matches:s?e.current_sprint===s:"N/A (no filter)"}))});let d=a||[];n&&(d=d.filter(e=>{var r;return((r=e.initiatives)==null?void 0:r.squad_id)===n})),console.log("[DEVELOPER_METRICS] Issues después de filtrar por squad:",{total:d.length,sprintNameFilter:s,uniqueCurrentSprints:[...new Set(d.map(e=>e.current_sprint).filter(Boolean))],issuesBySprint:d.reduce((e,r)=>{const g=r.current_sprint||"Backlog";return e[g]=(e[g]||0)+1,e},{})});const u=d.map(e=>{var r,g;return{id:e.id,key:e.issue_key,summary:e.summary,status:e.current_status,storyPoints:e.current_story_points||0,hasSP:(e.current_story_points||0)>0,squad:((g=(r=e.initiatives)==null?void 0:r.squads)==null?void 0:g.squad_name)||"Unknown"}}),c=e=>{if(!e)return!1;const r=e.trim().toUpperCase();return r==="DONE"||r==="DEVELOPMENT DONE"||r.includes("DEVELOPMENT DONE")||r.includes("DEV DONE")||r.includes("DONE")&&!r.includes("TO DO")&&!r.includes("TODO")||r==="CLOSED"||r==="RESOLVED"||r==="COMPLETED"},D=u.length,y=u.filter(e=>e.hasSP).length,q=u.filter(e=>!e.hasSP).length,P=u.reduce((e,r)=>e+r.storyPoints,0),w=u.filter(e=>c(e.status)).length,S=u.filter(e=>c(e.status)&&e.hasSP).reduce((e,r)=>e+r.storyPoints,0),m=u.filter(e=>e.hasSP).reduce((e,r)=>e+r.storyPoints,0),f={};return u.forEach(e=>{const r=e.status||"Unknown";f[r]||(f[r]={count:0,percentage:0}),f[r].count++}),Object.keys(f).forEach(e=>{f[e].percentage=D>0?Math.round(f[e].count/D*100):0}),{tickets:u,metrics:{totalTickets:D,withSP:y,noSP:q,totalSP:P,devDone:w,devDoneSP:S,totalSPAssigned:m,devDoneRate:D>0?Math.round(w/D*100):0,spDevDoneRate:m>0?Math.round(S/m*100):0},statusBreakdown:f}}catch(s){throw console.error("[DEVELOPER_METRICS] Error obteniendo métricas:",s),s}},C=async t=>{if(!i)throw new Error("Supabase no está configurado");if(!t)throw new Error("Developer ID es requerido");if(typeof t!="string"||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))throw console.error("[DEVELOPER_METRICS] ID inválido:",t,typeof t),new Error(`ID de desarrollador inválido: ${t}. Debe ser un UUID válido.`);try{const{data:o,error:l}=await i.from("developers").select("id, display_name, email").eq("id",t).single();if(l)throw l;return o}catch(o){throw console.error("[DEVELOPER_METRICS] Error obteniendo developer:",o),o}};export{O as a,v as b,L as c,C as d,T as g};
