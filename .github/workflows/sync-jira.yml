name: Jira ‚Üí Supabase Sync

on:
  schedule:
    # Ejecuta cada 30 minutos
    - cron: '*/30 * * * *'
  workflow_dispatch: # Permite ejecuci√≥n manual desde GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        working-directory: jira-supabase-sync
        run: npm ci
      
      - name: Verify configuration
        working-directory: jira-supabase-sync
        continue-on-error: true
        env:
          PROJECTS_CONFIG: ${{ secrets.PROJECTS_CONFIG }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üîç Verificando configuraci√≥n..."
          npm run verify-config || echo "‚ö†Ô∏è Verificaci√≥n fall√≥, pero continuando..."
      
      - name: Run sync
        working-directory: jira-supabase-sync
        id: sync
        continue-on-error: true
        env:
          # Configuraci√≥n de proyectos (JSON con todos los proyectos)
          PROJECTS_CONFIG: ${{ secrets.PROJECTS_CONFIG }}
          # O usar variables individuales si prefieres:
          # PROJECT_1_KEY: ${{ secrets.PROJECT_1_KEY }}
          # PROJECT_1_NAME: ${{ secrets.PROJECT_1_NAME }}
          # PROJECT_1_JIRA_DOMAIN: ${{ secrets.PROJECT_1_JIRA_DOMAIN }}
          # PROJECT_1_JIRA_EMAIL: ${{ secrets.PROJECT_1_JIRA_EMAIL }}
          # PROJECT_1_JIRA_API_TOKEN: ${{ secrets.PROJECT_1_JIRA_API_TOKEN }}
          # ... (repetir para cada proyecto)
          # Supabase (compartido para todos los proyectos)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SYNC_INTERVAL_MINUTES: '30'
        run: |
          echo "üöÄ Iniciando sincronizaci√≥n..."
          echo "üìã Proyectos configurados: $(echo '${{ secrets.PROJECTS_CONFIG }}' | jq -r 'length' 2>/dev/null || echo 'N/A')"
          npm run sync 2>&1 | tee sync-output.log || {
            EXIT_CODE=$?
            echo "‚ùå Sync fall√≥ con c√≥digo: $EXIT_CODE"
            echo "üìÑ √öltimas 50 l√≠neas del log:"
            tail -n 50 sync-output.log || true
            exit $EXIT_CODE
          }
      
      - name: Upload sync output
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: sync-output
          path: |
            jira-supabase-sync/sync-output.log
          retention-days: 7
      
      - name: Check sync result
        if: steps.sync.outcome == 'failure'
        run: |
          echo "‚ùå Sync failed. Check the logs above for details."
          exit 1
